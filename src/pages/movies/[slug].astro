---
import { getEntryBySlug, getCollection } from 'astro:content';
import Plyr from 'plyr';

const movie = await getEntryBySlug('movies', Astro.params.slug);
const relatedMovies = (await getCollection('movies')).filter(m => m.slug !== movie.slug);
let showPlayer = false;
---

<section class="max-w-5xl mx-auto p-4">
  <img src={movie.data.poster} alt={movie.data.title} class="rounded-lg shadow-lg" />
  <h1 class="text-3xl font-bold mt-4">{movie.data.title}</h1>
  <p class="mt-2">{movie.data.description}</p>
  <p class="mt-2 text-gray-500">Tags: {movie.data.tags.join(", ")}</p>

  <button class="mt-4 bg-red-600 text-white px-4 py-2 rounded hover:bg-red-700" onClick={() => showPlayer = !showPlayer}>
    المشاهدة الآن
  </button>

  {showPlayer && (
    <div class="mt-4">
      <video id="player" controls class="w-full rounded-lg">
        <source src={movie.data.video} type={movie.data.video.endsWith('.m3u8') ? 'application/x-mpegURL' : 'video/mp4'} />
      </video>
    </div>
  )}

  <section class="related-movies mt-8">
    <h2 class="text-2xl font-bold mb-4">أفلام أخرى</h2>
    <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
      {relatedMovies.slice(0,4).map(m => (
        <a href={`/movies/${m.slug}`} class="hover:scale-105 transition-transform">
          <img src={m.data.poster} alt={m.data.title} class="rounded-lg shadow-md" />
          <p class="text-center mt-2">{m.data.title}</p>
        </a>
      ))}
    </div>
  </section>
</section>
