---
import { getEntryBySlug, getCollection } from 'astro:content';
import Plyr from 'plyr';

const series = await getEntryBySlug('series', Astro.params.slug);
const episodes = await getCollection('episodes');
const seriesEpisodes = episodes.filter(e => e.data.seriesSlug === series.slug);
const relatedSeries = (await getCollection('series')).filter(s => s.slug !== series.slug);
let showPlayer = null;
---

<section class="max-w-5xl mx-auto p-4">
  <img src={series.data.poster} alt={series.data.title} class="rounded-lg shadow-lg" />
  <h1 class="text-3xl font-bold mt-4">{series.data.title}</h1>
  <p class="mt-2">{series.data.description}</p>
  <p class="mt-2 text-gray-500">Tags: {series.data.tags.join(", ")}</p>

  <!-- الحلقات والمواسم -->
  {series.data.seasons.map(season => (
    <section class="season mt-6">
      <h2 class="text-2xl font-bold mb-2">الموسم {season.number}</h2>
      <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
        {seriesEpisodes.filter(ep => ep.data.season === season.number).map(ep => (
          <div class="episode">
            <img src={ep.data.poster} alt={ep.data.title} class="rounded-lg shadow-md"/>
            <h3 class="mt-2">{ep.data.title}</h3>
            <button class="mt-2 bg-red-600 text-white px-3 py-1 rounded hover:bg-red-700" onClick={() => showPlayer = ep.data.video}>
              المشاهدة الآن
            </button>
          </div>
        ))}
      </div>
    </section>
  ))}

  <!-- مشغل الفيديو -->
  {showPlayer && (
    <div class="mt-4">
      <video id="player" controls class="w-full rounded-lg">
        <source src={showPlayer} type={showPlayer.endsWith('.m3u8') ? 'application/x-mpegURL' : 'video/mp4'} />
      </video>
    </div>
  )}

  <!-- حلقات أخرى -->
  <section class="other-episodes mt-8">
    <h2 class="text-2xl font-bold mb-4">حلقات أخرى</h2>
    <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
      {seriesEpisodes.slice(0,4).map(ep => (
        <a href={`/series/${ep.data.seriesSlug}/episode/${ep.slug}`}>
          <img src={ep.data.poster} alt={ep.data.title} class="rounded-lg shadow-md" />
          <p class="text-center mt-2">{ep.data.title}</p>
        </a>
      ))}
    </div>
  </section>

  <!-- مسلسلات مشابهة -->
  <section class="similar-series mt-8">
    <h2 class="text-2xl font-bold mb-4">مسلسلات مشابهة</h2>
    <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
      {relatedSeries.slice(0,4).map(s => (
        <a href={`/series/${s.slug}`} class="hover:scale-105 transition-transform">
          <img src={s.data.poster} alt={s.data.title} class="rounded-lg shadow-md" />
          <p class="text-center mt-2">{s.data.title}</p>
        </a>
      ))}
    </div>
  </section>
</section>
