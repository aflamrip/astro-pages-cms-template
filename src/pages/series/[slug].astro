---
import { getEntryBySlug, getCollection } from 'astro:content';
import Plyr from 'plyr';

const series = await getEntryBySlug('series', Astro.params.slug);
const episodes = await getCollection('episodes'); // جميع الحلقات
const seriesEpisodes = episodes.filter(e => e.data.seriesSlug === series.slug);
let showPlayer = null; // لتحديد الحلقة التي سيتم تشغيلها
---

<section class="series-page">
  <img src={series.data.poster} alt={series.data.title} />
  <h1>{series.data.title}</h1>
  <p>{series.data.description}</p>
  <p>Tags: {series.data.tags.join(", ")}</p>

  <!-- الحلقات حسب الموسم -->
  {series.data.seasons.map(season => (
    <section class="season">
      <h2>الموسم {season.number}</h2>
      <div class="grid">
        {seriesEpisodes.filter(ep => ep.data.season === season.number).map(ep => (
          <div class="episode">
            <img src={ep.data.poster} alt={ep.data.title} />
            <h3>{ep.data.title}</h3>
            <button onClick={() => showPlayer = ep.data.video}>المشاهدة الآن</button>
          </div>
        ))}
      </div>
    </section>
  ))}

  <!-- مشغل الفيديو -->
  {showPlayer && (
    <Plyr
      type="video"
      sources={[{ src: showPlayer, type: showPlayer.endsWith('.m3u8') ? 'application/x-mpegURL' : 'video/mp4' }]}
    />
  )}

  <!-- حلقات ومسلسلات مشابهة -->
  <section class="related">
    <h2>مسلسلات مشابهة</h2>
    <div class="grid">
      {seriesEpisodes.slice(0,4).map(ep => (
        <a href={`/series/${ep.data.seriesSlug}/episode/${ep.slug}`}>
          <img src={ep.data.poster} alt={ep.data.title} />
          <p>{ep.data.title}</p>
        </a>
      ))}
    </div>
  </section>
</section>
