---
export async function getStaticPaths() {
  const movies = await getCollection('movies');
  return movies.map(movie => ({
    params: { slug: movie.slug },
    props: { movie },
  }));
}

const { movie } = Astro.props;
const relatedMovies = await getCollection('movies', ({ data, slug }) => 
  slug !== movie.slug && data.genres.some(g => movie.data.genres.includes(g))
).then(movies => movies.slice(0, 6));
---

<Layout title={movie.data.title}>
  <div class="movie-page">
    <div class="movie-header">
      <img src={movie.data.poster} alt={movie.data.title} class="poster" />
      <div class="movie-info">
        <h1>{movie.data.title}</h1>
        
        <!-- Ø±ÙˆØ§Ø¨Ø· Ø§Ù„Ù…Ø´Ø§Ù‡Ø¯Ø© -->
        <div class="watch-links">
          {movie.data.videoUrl && (
            <button class="watch-btn" onclick="showPlayer()">
              â–¶ Ù…Ø´Ø§Ù‡Ø¯Ø© Ø§Ù„Ø¢Ù†
            </button>
          )}
          {movie.data.embedUrl && (
            <a href={movie.data.embedUrl} class="watch-btn" target="_blank">
              â–¶ Ù…Ø´Ø§Ù‡Ø¯Ø© Ø®Ø§Ø±Ø¬ÙŠØ©
            </a>
          )}
        </div>
        
        <!-- ØªÙØ§ØµÙŠÙ„ -->
        <div class="details">
          <span>ğŸ“… {movie.data.year}</span>
          <span>â±ï¸ {movie.data.duration}</span>
          <span>ğŸŒ {movie.data.country}</span>
          <span>ğŸ“º {movie.data.quality}</span>
        </div>
        
        <!-- Ø§Ù„ÙƒÙ„Ù…Ø§Øª Ø§Ù„Ø¯Ù„Ø§Ù„ÙŠØ© -->
        <div class="genres">
          {movie.data.genres.map(g => (
            <a href={`/genre/${g}/`} class="genre-tag">{g}</a>
          ))}
        </div>
        
        <!-- Ø§Ù„ÙˆØµÙ -->
        <div class="description">
          <h3>Ø§Ù„Ù‚ØµØ©</h3>
          <p>{movie.data.description}</p>
        </div>
      </div>
    </div>

    <!-- Ù…Ø´ØºÙ„ Ø§Ù„ÙÙŠØ¯ÙŠÙˆ (Ù…Ø®ÙÙŠ Ø¨Ø¯Ø§ÙŠØ©) -->
    <div id="player-container" style="display: none;">
      <VideoPlayer videoUrl={movie.data.videoUrl} embedUrl={movie.data.embedUrl} />
    </div>

    <!-- Ø£ÙÙ„Ø§Ù… Ù…Ø´Ø§Ø¨Ù‡Ø© -->
    <section class="related">
      <h2>Ø£ÙÙ„Ø§Ù… Ø£Ø®Ø±Ù‰</h2>
      <div class="media-grid">
        {relatedMovies.map(m => (
          <MediaCard 
            title={m.data.title}
            poster={m.data.poster}
            rating={m.data.rating}
            href={`/movie/${m.slug}/`}
            type="ÙÙŠÙ„Ù…"
          />
        ))}
      </div>
    </section>
  </div>
</Layout>

<script>
  function showPlayer() {
    const container = document.getElementById('player-container');
    container.style.display = 'block';
    container.scrollIntoView({ behavior: 'smooth' });
  }
</script>
