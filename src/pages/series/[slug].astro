---
import Layout from '../../layouts/Layout.astro';
import MediaCard from '../../components/MediaCard.astro';

// Ø¬Ù„Ø¨ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù…Ø³Ù„Ø³Ù„Ø§Øª Ù…Ù† Ø§Ù„ÙƒÙˆÙ„ÙƒØ´Ù†
export async function getStaticPaths() {
  const series = await getCollection('series');
  return series.map(serie => ({
    params: { slug: serie.slug },
    props: { serie },
  }));
}

const { serie } = Astro.props;
const { seasons } = serie.data;

// Ø¬Ù…Ø¹ ÙƒÙ„ Ø§Ù„Ø­Ù„Ù‚Ø§Øª ÙÙŠ Ù…ØµÙÙˆÙØ© ÙˆØ§Ø­Ø¯Ø©
const allEpisodes = seasons.flatMap(s => 
  s.episodes.map(e => ({ ...e, season: s.season }))
);

// Ø¥ÙŠØ¬Ø§Ø¯ Ù…Ø³Ù„Ø³Ù„Ø§Øª Ù…Ø´Ø§Ø¨Ù‡Ø© Ø¨Ø­Ø³Ø¨ Ø§Ù„Ù†ÙˆØ¹
const relatedSeries = await getCollection('series', ({ data, slug }) => 
  slug !== serie.slug && data.genres.some(g => serie.data.genres.includes(g))
).then(series => series.slice(0, 6));
---

<Layout title={serie.data.title}>
  <div class="series-page">
    <div class="series-header">
      <img src={serie.data.poster} alt={serie.data.title} class="poster" />
      <div class="series-info">
        <h1>{serie.data.title}</h1>
        
        <!-- Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ù…Ø³Ù„Ø³Ù„ -->
        <div class="details">
          <span>ğŸ“… {serie.data.year}</span>
          <span>ğŸŒ {serie.data.country}</span>
          <span>ğŸ“Š {seasons.length} Ù…ÙˆØ§Ø³Ù…</span>
        </div>
        
        <!-- Ø§Ù„ÙƒÙ„Ù…Ø§Øª Ø§Ù„Ø¯Ù„Ø§Ù„ÙŠØ© -->
        <div class="genres">
          {serie.data.genres.map(g => (
            <a href={`/genre/${g}/`} class="genre-tag">{g}</a>
          ))}
        </div>
        
        <!-- Ø§Ù„ÙˆØµÙ -->
        <div class="description">
          <h3>Ø§Ù„Ù‚ØµØ©</h3>
          <p>{serie.data.description}</p>
        </div>
      </div>
    </div>

    <!-- Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø­Ù„Ù‚Ø§Øª -->
    <section class="episodes-section">
      <h2>Ø§Ù„Ø­Ù„Ù‚Ø§Øª</h2>
      {seasons.map(season => (
        <div class="season">
          <h3>Ø§Ù„Ù…ÙˆØ³Ù… {season.season}</h3>
          <div class="episodes-grid">
            {season.episodes.map(ep => (
              <a 
                href={`/series/${serie.slug}/season/${season.season}/episode/${ep.episode}/`}
                class="episode-card"
              >
                <span class="ep-number">{ep.episode}</span>
                <span class="ep-title">{ep.title}</span>
              </a>
            ))}
          </div>
        </div>
      ))}
    </section>

    <!-- Ø­Ù„Ù‚Ø§Øª Ø£Ø®Ø±Ù‰ -->
    <section class="related-episodes">
      <h2>Ø­Ù„Ù‚Ø§Øª Ø£Ø®Ø±Ù‰</h2>
      <div class="episodes-list">
        {allEpisodes.slice(0, 10).map(ep => (
          <a href={`/series/${serie.slug}/season/${ep.season}/episode/${ep.episode}/`}>
            Ø§Ù„Ø­Ù„Ù‚Ø© {ep.episode} - {ep.title}
          </a>
        ))}
      </div>
    </section>

    <!-- Ù…Ø³Ù„Ø³Ù„Ø§Øª Ù…Ø´Ø§Ø¨Ù‡Ø© -->
    {relatedSeries.length > 0 && (
      <section class="related-series">
        <h2>Ù…Ø³Ù„Ø³Ù„Ø§Øª Ù…Ø´Ø§Ø¨Ù‡Ø©</h2>
        <div class="media-grid">
          {relatedSeries.map(s => (
            <MediaCard
              title={s.data.title}
              poster={s.data.poster}
              rating={s.data.rating}
              href={`/series/${s.slug}/`}
              type="Ù…Ø³Ù„Ø³Ù„"
            />
          ))}
        </div>
      </section>
    )}
  </div>
</Layout>
